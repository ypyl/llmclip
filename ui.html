<!DOCTYPE html>
<html>
  <head>
    <script src="marked.min.js"></script>
    <script src="mermaid.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0 auto;
        padding: 0px 5px;
      }
      .code-block-wrapper {
        margin: 16px 0;
      }
      pre {
        background-color: #f6f8fa;
        padding: 16px;
        border-radius: 6px;
        margin: 0;
      }
      code {
        font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
      }
      .collapsed code {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .quote-button {
        position: fixed;
        display: none;
        background-color: #ffffff;
        color: #666;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 10px;
        cursor: pointer;
        font-size: 12px;
        box-shadow: none;
        z-index: 1000;
      }
      .quote-button:hover {
        background-color: #e6f2fa;
        border-color: #999;
      }
      .mermaid-wrapper > .mermaid {
        padding: 16px;
        background-color: #f6f8fa;
        border-radius: 6px;
        margin-bottom: 8px;
      }
      .custom-button {
        padding: 4px 10px;
        margin-left: 4px;
        background-color: #ffffff;
        color: #666;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-style: normal;
      }
      .custom-button:hover {
        background-color: #e6f2fa;
        border-color: #999;
      }
      .thinking-block-wrapper {
        margin: 16px 0;
      }
      .thinking-block {
        padding: 12px;
        background-color: #f9f9f9;
        border-left: 3px solid #999;
        border-radius: 4px;
        font-size: 0.85em;
        font-style: italic;
        color: #666;
        white-space: pre-wrap;
        word-wrap: break-word;
        margin-bottom: 8px;
      }
      .thinking-block-wrapper.collapsed .thinking-block {
        display: -webkit-box;
        line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      #settings-container {
        display: flex;
        flex-direction: column;
        padding-top: 5px;
        padding-bottom: 5px;
      }

      .settings-editor {
        flex-grow: 1;
      }
      #settings-editor {
        width: 100%;

        font-family: "Courier New", monospace;
        font-size: 14px;
      }
      .settings-buttons {
        margin-top: 10px;
        margin-bottom: 5px;
      }
      .settings-buttons button {
        margin-right: 10px;
        padding: 8px 16px;
      }

      h3 {
        margin: 5px 0;
      }

      /* Settings Form Styles */
      .field-group {
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 4px;
        background-color: #fff;
      }
      .field-group:not(:last-child) {
        margin-bottom: 20px;
      }
      .field:not(:last-child) {
        margin-bottom: 15px;
      }
      .field label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
      }
      .field-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }
      .field-row label {
        width: 140px;
        font-weight: 500;
        color: #333;
      }
      .settings-input,
      .settings-select,
      .settings-textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-family: inherit;
      }
      .settings-textarea {
        resize: vertical;
        min-height: 80px;
      }
      .prompt-item:not(:last-child) {
        border: 1px solid #eee;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        position: relative;
        background: #fcfcfc;
      }
      .header-section {
        display: flex;
        align-items: center;
        gap: 15px;
        padding-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div id="content"></div>
    <div id="settings-container" style="display: none">
      <div class="header-section">
        <label for="selectedLLM">Active Provider:</label>
        <select
          id="selectedLLM"
          class="settings-select"
          style="width: auto"
          onchange="updateSelectedLLM(this.value)"
        ></select>
      </div>

      <div class="settings-editor" id="editorContent">
        <!-- Editor content will be injected here -->
      </div>

      <div class="settings-buttons">
        <button class="custom-button" onclick="saveSettings()">Save</button>
      </div>
    </div>
    <button id="quoteBtn" class="quote-button">Quote</button>
    <script>
      // Configure marked to customize code block rendering
      marked.setOptions({
        renderer: new marked.Renderer(),
        highlight: function (code, lang) {
          return code; // No syntax highlighting for simplicity
        },
        gfm: true,
        breaks: true,
        sanitize: false, // This must be false to allow HTML
      });

      // Function to copy code to clipboard
      function copyCode(button) {
        const codeElement = button.previousElementSibling.previousElementSibling;
        const text = codeElement.textContent;
        window.chrome.webview.hostObjects.sync.clipboard.Copy(text);
      }

      // Function to toggle code block visibility
      function toggle(button) {
        const wrapper = button.closest(".code-block-wrapper");
        wrapper.classList.toggle("collapsed");
        button.textContent = wrapper.classList.contains("collapsed") ? "Expand" : "Collapse";
      }

      // Function to toggle thinking block visibility
      function toggleThinking(button) {
        const wrapper = button.closest(".thinking-block-wrapper");
        wrapper.classList.toggle("collapsed");
        button.textContent = wrapper.classList.contains("collapsed") ? "Expand" : "Collapse";
      }

      // Function to save Mermaid diagram as SVG
      function saveMermaidDiagram(button) {
        const wrapper = button.closest(".mermaid-wrapper");
        const svgElement = wrapper.querySelector("svg");
        if (!svgElement) return;

        // Get the SVG as a string
        const svgData = new XMLSerializer().serializeToString(svgElement);

        // Send to AutoHotkey host for saving
        window.chrome.webview.hostObjects.sync.clipboard.SaveDiagram(svgData);
      }

      // Override the code block renderer to include copy and toggle buttons
      const renderer = new marked.Renderer();
      renderer.code = function (code, infostring, escaped) {
        if (code.lang === "mermaid") {
          return (
            '<div class="mermaid-wrapper"><div class="mermaid">' +
            code.text +
            '</div><button class="custom-button" onclick="saveMermaidDiagram(this)">Save as SVG</button></div>'
          );
        }
        if (code.lang === "thinking") {
          return `<div class="thinking-block-wrapper collapsed"><div class="thinking-block">${code.text}</div><button class="custom-button" onclick="toggleThinking(this)">Expand</button></div>`;
        }
        return `<div class="code-block-wrapper"><pre><code>${code.text}</code></pre><button class="custom-button" onclick="copyCode(this)">Copy</button><button class="custom-button" onclick="toggle(this)">Collapse</button></div>`;
      };

      mermaid.initialize({ startOnLoad: false });

      function renderMarkdown(content) {
        document.getElementById("settings-container").style.display = "none";
        document.getElementById("content").style.display = "block";
        const quoteBtn = document.getElementById("quoteBtn");
        if (quoteBtn) {
          quoteBtn.style.display = "none";
        }
        document.getElementById("content").innerHTML = marked.parse(content, {
          renderer: renderer,
        });
        mermaid.run({
          nodes: document.querySelectorAll(".mermaid"),
        });
      }

      let settings = {};
      let editingProviderKey = "";

      function escapeHtml(text) {
        if (!text) return "";
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function showSettings(settingsJson) {
        document.getElementById("content").style.display = "none";
        document.getElementById("settings-container").style.display = "flex";

        try {
          settings = JSON.parse(settingsJson);

          // Populate provider dropdown
          const select = document.getElementById("selectedLLM");
          select.innerHTML = "";
          if (settings.providers) {
            Object.keys(settings.providers).forEach((key) => {
              const opt = document.createElement("option");
              opt.value = key;
              opt.textContent = key;
              if (key === settings.selectedLLMType) opt.selected = true;
              select.appendChild(opt);
            });
            editingProviderKey = settings.selectedLLMType;
            renderEditor();
          } else {
            document.getElementById("editorContent").innerHTML = "No providers found in settings.";
          }
        } catch (e) {
          console.error("Failed to parse settings JSON:", e);
          document.getElementById("editorContent").innerHTML = "Error parsing settings JSON.";
        }
      }

      function updateSelectedLLM(val) {
        settings.selectedLLMType = val;
        editingProviderKey = val;
        renderEditor();
      }

      let selectedSystemPromptIndex = 0;

      function renderEditor() {
        const container = document.getElementById("editorContent");
        container.innerHTML = ""; // Clear

        if (!settings.providers) return;
        const provider = settings.providers[editingProviderKey];

        if (!provider) {
          container.innerHTML = "Select a provider to edit.";
          return;
        }

        const html = `
                <div class="field-group">
                    <h3>Provider Configuration: ${escapeHtml(editingProviderKey)}</h3>

                    <div class="field">
                        <label>Model Name</label>
                        <input type="text" class="settings-input" value="${escapeHtml(
                          provider.model || ""
                        )}" oninput="updateProviderField('model', this.value)">
                    </div>

                    <div class="field">
                        <label>CURL Command</label>
                        <input type="text" class="settings-input" value="${escapeHtml(
                          provider.curl || ""
                        )}" oninput="updateProviderField('curl', this.value)">
                    </div>

                    <div class="field">
                        <label>Compression Prompt</label>
                        <textarea class="settings-textarea" oninput="updateProviderField('compression_prompt', this.value)">${escapeHtml(
                          provider.compression_prompt || ""
                        )}</textarea>
                    </div>

                    <div class="field-row">
                        <label>Temperature</label>
                        <input type="number" class="settings-input" step="0.1" style="width: 80px" value="${
                          provider.temperature || 0.7
                        }" oninput="updateProviderField('temperature', parseFloat(this.value))">
                    </div>

                    <div class="field-row">
                        <label>Tools</label>
                        <input type="checkbox"
                            id="tool_powerShellTool"
                            ${provider.tools && provider.tools.includes("powerShellTool") ? "checked" : ""}
                            onchange="toggleProviderTool('powerShellTool', this.checked)">
                        <span style="font-size: 0.85em; color: #666;">powerShellTool</span>
                    </div>

                    <div class="field-row">
                        <label>Stream</label>
                        <input type="checkbox" ${
                          provider.stream ? "checked" : ""
                        } onchange="updateProviderField('stream', this.checked)">
                        <span style="font-size: 0.85em; color: #666;">Enable streaming responses</span>
                    </div>

                    <div class="field-row">
                        <label>Images</label>
                        <input type="checkbox" ${
                          provider.image ? "checked" : ""
                        } onchange="updateProviderField('image', this.checked)">
                        <span style="font-size: 0.85em; color: #666;">Enable image input support</span>
                    </div>
                </div>

                <div class="field-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin:0">System Prompts</h3>
                    </div>

                    <div class="field-row" style="margin-bottom: 20px;">
                        <select id="systemPromptSelect" class="settings-select" onchange="updateSelectedSystemPrompt(this.value)"></select>
                        <button class="custom-button" onclick="addSystemPrompt()">Add New</button>
                        <button class="custom-button" onclick="deleteSystemPrompt()">Delete</button>
                    </div>

                    <div id="selectedPromptEditor"></div>
                </div>
            `;

        container.innerHTML = html;
        renderSystemPrompts();
      }

      function renderSystemPrompts() {
        const select = document.getElementById("systemPromptSelect");
        if (!select) return;

        const provider = settings.providers[editingProviderKey];
        provider.system_prompts = provider.system_prompts || [];

        // Save current selection if possible, or keep existing index
        const currentIndex = selectedSystemPromptIndex;

        select.innerHTML = "";

        if (provider.system_prompts.length === 0) {
          const opt = document.createElement("option");
          opt.text = "(No prompts created)";
          opt.disabled = true;
          select.appendChild(opt);
          document.getElementById("selectedPromptEditor").innerHTML = "<em>No system prompt selected.</em>";
          return;
        }

        provider.system_prompts.forEach((prompt, index) => {
          const opt = document.createElement("option");
          opt.value = index;
          opt.text = prompt.name || `Prompt ${index + 1}`;
          if (index === currentIndex) opt.selected = true;
          select.appendChild(opt);
        });

        // Ensure index is valid
        if (selectedSystemPromptIndex >= provider.system_prompts.length) {
          selectedSystemPromptIndex = 0;
          if (provider.system_prompts.length > 0) select.value = 0;
        } else {
          select.value = selectedSystemPromptIndex;
        }

        renderSelectedSystemPrompt();
      }

      function renderSelectedSystemPrompt() {
        const container = document.getElementById("selectedPromptEditor");
        const provider = settings.providers[editingProviderKey];
        if (!provider.system_prompts || provider.system_prompts.length === 0) {
          container.innerHTML = "";
          return;
        }

        const prompt = provider.system_prompts[selectedSystemPromptIndex];
        const index = selectedSystemPromptIndex;

        // Ensure context array exists
        const contextItems = prompt.context || [];

        let contextHtml = "";
        contextItems.forEach((ctxPath, ctxIndex) => {
          contextHtml += `
                <div class="field-row" style="margin-bottom: 5px;">
                    <input type="text" class="settings-input" value="${escapeHtml(ctxPath)}"
                           placeholder="File path (e.g. C:\\Code\\file.md)"
                           oninput="updateContextItem(${index}, ${ctxIndex}, this.value)">
                    <button class="custom-button" onclick="removeContextItem(${index}, ${ctxIndex})">Remove</button>
                </div>
            `;
        });

        container.innerHTML = `
            <div class="field">
                <label>Name</label>
                <input type="text" class="settings-input" value="${escapeHtml(
                  prompt.name || ""
                )}" oninput="updateSystemPrompt(${index}, 'name', this.value)">
            </div>
            <div class="field">
                <label>Prompt Content</label>
                <textarea class="settings-textarea" style="height: 100px;" oninput="updateSystemPrompt(${index}, 'value', this.value)">${escapeHtml(
          prompt.value || ""
        )}</textarea>
            </div>
            <div class="field">
                <label>Input Template</label>
                <textarea class="settings-textarea" style="height: 100px;" oninput="updateSystemPrompt(${index}, 'input_template', this.value)">${escapeHtml(
          prompt.input_template || ""
        )}</textarea>
            </div>
            <div class="field">
                <label>Context</label>
                <div style="margin-bottom: 10px;">
                    ${contextHtml}
                </div>
                <button class="custom-button" onclick="addContextItem(${index})">Add Context</button>
            </div>
        `;
      }

      function addContextItem(promptIndex) {
        if (!settings.providers[editingProviderKey].system_prompts[promptIndex].context) {
          settings.providers[editingProviderKey].system_prompts[promptIndex].context = [];
        }
        settings.providers[editingProviderKey].system_prompts[promptIndex].context.push("");
        renderSelectedSystemPrompt();
      }

      function removeContextItem(promptIndex, contextIndex) {
        if (settings.providers[editingProviderKey].system_prompts[promptIndex].context) {
          settings.providers[editingProviderKey].system_prompts[promptIndex].context.splice(contextIndex, 1);
          renderSelectedSystemPrompt();
        }
      }

      function updateContextItem(promptIndex, contextIndex, value) {
        if (settings.providers[editingProviderKey].system_prompts[promptIndex].context) {
          settings.providers[editingProviderKey].system_prompts[promptIndex].context[contextIndex] = value;
        }
      }

      function updateSelectedSystemPrompt(val) {
        selectedSystemPromptIndex = parseInt(val);
        renderSelectedSystemPrompt();
      }

      function updateProviderField(field, val) {
        if (settings.providers && settings.providers[editingProviderKey]) {
          settings.providers[editingProviderKey][field] = val;
        }
      }

      function toggleProviderTool(toolName, isChecked) {
        if (settings.providers && settings.providers[editingProviderKey]) {
          let tools = settings.providers[editingProviderKey].tools || [];
          if (isChecked) {
            if (!tools.includes(toolName)) {
              tools.push(toolName);
            }
          } else {
            tools = tools.filter((t) => t !== toolName);
          }
          settings.providers[editingProviderKey].tools = tools;
        }
      }

      function updateSystemPrompt(index, field, val) {
        if (
          settings.providers &&
          settings.providers[editingProviderKey] &&
          settings.providers[editingProviderKey].system_prompts
        ) {
          settings.providers[editingProviderKey].system_prompts[index][field] = val;

          // If name changes, update dropdown text
          if (field === "name") {
            const select = document.getElementById("systemPromptSelect");
            if (select && select.options[index]) {
              select.options[index].text = val;
            }
          }
        }
      }

      function addSystemPrompt() {
        if (!settings.providers[editingProviderKey].system_prompts) {
          settings.providers[editingProviderKey].system_prompts = [];
        }
        const newLength = settings.providers[editingProviderKey].system_prompts.push({
          name: "New Prompt",
          value: "",
          input_template: "",
          context: [],
        });
        selectedSystemPromptIndex = newLength - 1;
        renderSystemPrompts();
      }

      function deleteSystemPrompt() {
        const provider = settings.providers[editingProviderKey];
        if (!provider.system_prompts || provider.system_prompts.length === 0) return;

        if (confirm("Delete this system prompt?")) {
          provider.system_prompts.splice(selectedSystemPromptIndex, 1);
          if (selectedSystemPromptIndex >= provider.system_prompts.length) {
            selectedSystemPromptIndex = Math.max(0, provider.system_prompts.length - 1);
          }
          renderSystemPrompts();
        }
      }

      function saveSettings() {
        if (settings.providers) {
          for (const [key, provider] of Object.entries(settings.providers)) {
            if (!provider.curl || !provider.curl.trim()) {
              alert(`Provider '${key}': CURL Command cannot be empty.`);
              return;
            }

            if (provider.system_prompts) {
              for (let i = 0; i < provider.system_prompts.length; i++) {
                const prompt = provider.system_prompts[i];
                if (!prompt.name || !prompt.name.trim()) {
                  alert(`Provider '${key}', System Prompt #${i + 1}: Name cannot be empty.`);
                  return;
                }
                if (!prompt.value || !prompt.value.trim()) {
                  alert(`Provider '${key}', System Prompt '${prompt.name}': Content cannot be empty.`);
                  return;
                }
              }
            }
          }
        }

        console.log("Saving settings:", settings);

        // Store settings globally for AutoHotkey to retrieve
        window.chrome.webview.hostObjects.sync.settings.Save(JSON.stringify(settings));
      }

      // Quote button logic
      const quoteBtn = document.getElementById("quoteBtn");

      document.addEventListener("selectionchange", () => {
        const selection = window.getSelection();
        if (selection.isCollapsed) {
          quoteBtn.style.display = "none";
        }
      });

      document.addEventListener("mouseup", (e) => {
        const selection = window.getSelection();
        const text = selection.toString().trim();

        if (text) {
          const range = selection.getRangeAt(0);
          const rect = range.getBoundingClientRect();

          // Position button above the selection
          let top = rect.top - 30;
          let left = rect.left + rect.width / 2 - quoteBtn.offsetWidth / 2;

          // Ensure button stays within viewport
          if (top < 0) top = rect.bottom + 10;
          if (left < 0) left = 10;
          if (left + quoteBtn.offsetWidth > window.innerWidth) {
            left = window.innerWidth - quoteBtn.offsetWidth - 10;
          }

          quoteBtn.style.top = `${top}px`;
          quoteBtn.style.left = `${left}px`;
          quoteBtn.style.display = "block";
        } else {
          quoteBtn.style.display = "none";
        }
      });

      quoteBtn.addEventListener("click", () => {
        const text = window.getSelection().toString().trim();
        if (text) {
          window.chrome.webview.hostObjects.sync.input.Append(text);
          window.getSelection().removeAllRanges();
          quoteBtn.style.display = "none";
        }
      });
    </script>
  </body>
</html>
