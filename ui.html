<!doctype html>
<html>
  <head>
    <script src="marked.min.js"></script>
    <script src="mermaid.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0 auto;
        padding: 0px 5px;
      }
      .code-block-wrapper {
        margin: 16px 0;
      }
      pre {
        background-color: #f6f8fa;
        padding: 16px;
        border-radius: 6px;
        margin: 0;
      }
      code {
        font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
      }
      .collapsed code {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .quote-button {
        position: fixed;
        display: none;
        background-color: #ffffff;
        color: #666;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 10px;
        cursor: pointer;
        font-size: 12px;
        box-shadow: none;
        z-index: 1000;
      }
      .quote-button:hover {
        background-color: #e6f2fa;
        border-color: #999;
      }
      .mermaid-wrapper > .mermaid {
        padding: 16px;
        background-color: #f6f8fa;
        border-radius: 6px;
        margin-bottom: 8px;
      }
      .custom-button {
        padding: 4px 10px;
        margin-left: 4px;
        background-color: #ffffff;
        color: #666;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-style: normal;
      }
      .custom-button:hover {
        background-color: #e6f2fa;
        border-color: #999;
      }
      .thinking-block-wrapper {
        margin: 16px 0;
      }
      .thinking-block {
        padding: 12px;
        background-color: #f9f9f9;
        border-left: 3px solid #999;
        border-radius: 4px;
        font-size: 0.85em;
        font-style: italic;
        color: #666;
        white-space: pre-wrap;
        word-wrap: break-word;
        margin-bottom: 8px;
      }
      .thinking-block-wrapper.collapsed .thinking-block {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div id="content"></div>

    <button id="quoteBtn" class="quote-button">Quote</button>
    <script>
      // Configure marked to customize code block rendering
      marked.setOptions({
        renderer: new marked.Renderer(),
        highlight: function (code, lang) {
          return code; // No syntax highlighting for simplicity
        },
        gfm: true,
        breaks: true,
        sanitize: false, // This must be false to allow HTML
      });

      // Function to copy code to clipboard
      function copyCode(button) {
        const wrapper = button.closest(".code-block-wrapper");
        const codeElement = wrapper.querySelector("code");
        const text = codeElement.textContent;
        window.chrome.webview.hostObjects.sync.clipboard.Copy(text);
      }

      // Function to toggle code block visibility
      function toggle(button) {
        const wrapper = button.closest(".code-block-wrapper");
        wrapper.classList.toggle("collapsed");
        button.textContent = wrapper.classList.contains("collapsed") ? "Expand" : "Collapse";
      }

      // Function to toggle thinking block visibility
      function toggleThinking(button) {
        const wrapper = button.closest(".thinking-block-wrapper");
        wrapper.classList.toggle("collapsed");
        button.textContent = wrapper.classList.contains("collapsed") ? "Expand" : "Collapse";
      }

      // Function to copy thinking block to clipboard
      function copyThinking(button) {
        const wrapper = button.closest(".thinking-block-wrapper");
        const thinkingElement = wrapper.querySelector(".thinking-block");
        const text = thinkingElement.textContent;
        window.chrome.webview.hostObjects.sync.clipboard.Copy(text);
      }

      // Function to save Mermaid diagram as SVG
      function saveMermaidDiagram(button) {
        const wrapper = button.closest(".mermaid-wrapper");
        const svgElement = wrapper.querySelector("svg");
        if (!svgElement) return;

        // Get the SVG as a string
        const svgData = new XMLSerializer().serializeToString(svgElement);

        // Send to AutoHotkey host for saving
        window.chrome.webview.hostObjects.sync.clipboard.SaveDiagram(svgData);
      }

      // Override the code block renderer to include copy and toggle buttons
      const renderer = new marked.Renderer();
      renderer.code = function (token) {
        const { text, lang } = token;

        // Handle Mermaid
        if (lang === "mermaid") {
          // We need a unique ID for mermaid.render() to target
          const uniqueId = "mer-" + Math.random().toString(36).substr(2, 9);
          return `
      <div class="mermaid-wrapper" id="wrapper-${uniqueId}">
        <div class="mermaid" id="${uniqueId}">${text}</div>
        <button class="custom-button" onclick="saveMermaidDiagram(this)">Save as SVG</button>
      </div>`;
        }

        // Handle Thinking
        if (lang === "thinking") {
          return `<div class="thinking-block-wrapper collapsed"><div class="thinking-block">${text}</div><button class="custom-button" onclick="copyThinking(this)">Copy</button><button class="custom-button" onclick="toggleThinking(this)">Expand</button></div>`;
        }

        // Handle Standard Code
        return `<div class="code-block-wrapper"><pre><code>${text}<code></pre><button class="custom-button" onclick="copyCode(this)">Copy</button><button class="custom-button" onclick="toggle(this)">Collapse</button></div>`;
      };

      mermaid.initialize({ startOnLoad: false, suppressErrorRendering: true });

      async function renderMarkdown(content) {
        const quoteBtn = document.getElementById("quoteBtn");
        if (quoteBtn) {
          quoteBtn.style.display = "none";
        }

        // 1. Parse Markdown
        document.getElementById("content").innerHTML = marked.parse(content, {
          renderer: renderer,
        });

        // 2. Select all mermaid nodes
        const mermaidNodes = document.querySelectorAll(".mermaid");

        // 3. Render them manually to catch errors
        for (const node of mermaidNodes) {
          const rawCode = node.textContent;
          const id = node.id;
          const wrapper = document.getElementById(`wrapper-${id}`);

          try {
            // Clear text before rendering
            node.textContent = "";

            // Attempt render
            const { svg } = await mermaid.render(id + "-svg", rawCode);
            node.innerHTML = svg;
          } catch (error) {
            // Deconstruct the error and show it to the user
            console.error("Mermaid Render Error:", error);

            // Inject error UI into the specific node
            node.innerHTML = `
        <div style="color: #d32f2f; background: #fff5f5; border: 1px solid #ff4d4d; padding: 12px; font-family: monospace; font-size: 0.9em; margin-bottom: 10px;">
          <strong>Mermaid Syntax Error:</strong>
          <pre style="white-space: pre-wrap; margin-top: 8px;">${error.message || error.str}</pre>
        </div>`;

            // Optional: Hide the save button if there is an error
            const saveBtn = wrapper.querySelector("button");
            if (saveBtn) saveBtn.style.display = "none";
          }
        }
      }

      // Quote button logic
      const quoteBtn = document.getElementById("quoteBtn");

      document.addEventListener("selectionchange", () => {
        const selection = window.getSelection();
        if (selection.isCollapsed) {
          quoteBtn.style.display = "none";
        }
      });

      document.addEventListener("mouseup", (e) => {
        const selection = window.getSelection();
        const text = selection.toString().trim();

        if (text) {
          const range = selection.getRangeAt(0);
          const rect = range.getBoundingClientRect();

          // Position button above the selection
          let top = rect.top - 30;
          let left = rect.left + rect.width / 2 - quoteBtn.offsetWidth / 2;

          // Ensure button stays within viewport
          if (top < 0) top = rect.bottom + 10;
          if (left < 0) left = 10;
          if (left + quoteBtn.offsetWidth > window.innerWidth) {
            left = window.innerWidth - quoteBtn.offsetWidth - 10;
          }

          quoteBtn.style.top = `${top}px`;
          quoteBtn.style.left = `${left}px`;
          quoteBtn.style.display = "block";
        } else {
          quoteBtn.style.display = "none";
        }
      });

      quoteBtn.addEventListener("click", () => {
        const text = window.getSelection().toString().trim();
        if (text) {
          window.chrome.webview.hostObjects.sync.input.Append(text);
          window.getSelection().removeAllRanges();
          quoteBtn.style.display = "none";
        }
      });
    </script>
  </body>
</html>
